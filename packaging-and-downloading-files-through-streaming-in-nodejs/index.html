<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="沉默入海"><link rel="shortcut icon" href=https://qqqy.dev/favicon.ico><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Noto+Serif+SC&display=swap" media=print onload='this.media="all"'><link rel=stylesheet href=/css/style.min.css><link rel=canonical href=https://qqqy.dev/packaging-and-downloading-files-through-streaming-in-nodejs/><link href=https://cdn.bootcdn.net/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css rel=stylesheet><script src=https://cdn.bootcdn.net/ajax/libs/highlight.js/11.7.0/highlight.min.js></script>
<script>hljs.initHighlightingOnLoad()</script><title>Packaging and downloading files through streaming in NodeJS</title></head><body><header id=banner><h2><a href=https://qqqy.dev>沉海记</a></h2><nav><ul><li><a href=/categories/ title=categories>categories</a></li><li><a href=/about/ title=about>about</a></li><li><a href=/resume/ title=résumé>résumé</a></li></ul></nav></header><main id=content><article><header id=post-header><h1>Packaging and downloading files through streaming in NodeJS</h1><div><time>September 21, 2023</time></div></header><h1 id=background>Background</h1><p>Last week, I developed a feature that can package the log files produced by the application into a <code>tar.gz</code> file and enable online downloading. While this is may seem like a straight forward feature, there are still some intriguing aspects worth documenting.</p><h1 id=generate-temporary-file-delete-later>Generate temporary file, delete later</h1><p>The simplest method to implement this feature is to generate a tarball on the server&rsquo;s disk and delete it after it&rsquo;s been downloaded. The code is roughly like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kr>import</span> <span class=nx>fs</span> <span class=nx>from</span> <span class=s1>&#39;fs&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>tar</span> <span class=nx>from</span> <span class=s1>&#39;tar&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>unlink</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;fs/promises&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>dowload</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>{</span> <span class=nx>files</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>ctx</span><span class=p>.</span><span class=nx>request</span><span class=p>.</span><span class=nx>body</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>file</span> <span class=o>=</span> <span class=s1>&#39;logs.tar.gz&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span><span class=p>.</span><span class=nx>attachment</span><span class=p>(</span><span class=nx>file</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>tar</span><span class=p>.</span><span class=nx>c</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>gzip</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>file</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=nx>files</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span><span class=p>.</span><span class=nx>body</span> <span class=o>=</span> <span class=nx>fs</span><span class=p>.</span><span class=nx>createReadStream</span><span class=p>(</span><span class=nx>__dirname</span> <span class=o>+</span> <span class=sb>`/</span><span class=si>${</span><span class=nx>file</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;end&#39;</span><span class=p>,</span> <span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=kr>await</span> <span class=nx>unlink</span><span class=p>(</span><span class=nx>file</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kr>await</span> <span class=nx>next</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><blockquote><p><strong>Note</strong><br>Since we use <a href=https://koajs.com/>Koa</a>, I can make use of <code>ctx.attachment</code>. It is equivalent to:</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=nx>ctx</span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=s1>&#39;Content-disposition&#39;</span><span class=p>,</span> <span class=s1>&#39;attachment; filename=&#39;</span> <span class=o>+</span> <span class=nx>filename</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>ctx</span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=s1>&#39;Content-type&#39;</span><span class=p>,</span> <span class=s1>&#39;application/gzip&#39;</span><span class=p>);</span>
</span></span></code></pre></div><h1 id=stream-based-packaging-and-download>Stream-based packaging and download</h1><p>Creating a temporary file and deleting it after download seems straightforward, but it can be considered cumbersome or less elegant since it still occupies disk space temporarily and may lead to issues if errors occur during this process and potential risk of leaving the file behind if deletion fails.</p><p>A common alternative is packaging files via streaming, demonstrated by the following code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-TypeScript data-lang=TypeScript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>tarFile</span> <span class=o>=</span> <span class=p>(</span><span class=nx>files</span>: <span class=kt>string</span><span class=p>[])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=nx>Promise</span><span class=p>((</span><span class=nx>resolve</span><span class=p>,</span> <span class=nx>reject</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>passthrough</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>stream</span><span class=p>.</span><span class=nx>PassThrougth</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>tar</span><span class=p>.</span><span class=nx>c</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>gzip</span>: <span class=kt>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=nx>files</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>pipe</span><span class=p>(</span><span class=nx>passthrough</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;end&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>passthrough</span><span class=p>.</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=nx>resolve</span><span class=p>(</span><span class=nx>passthrough</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=nx>reject</span><span class=p>(</span><span class=nx>err</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>dowload</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>{</span> <span class=nx>files</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>ctx</span><span class=p>.</span><span class=nx>request</span><span class=p>.</span><span class=nx>body</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span><span class=p>.</span><span class=nx>attachment</span><span class=p>(</span><span class=s1>&#39;logs.tar.gz&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span><span class=p>.</span><span class=nx>body</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>tarFile</span><span class=p>(</span><span class=nx>files</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>await</span> <span class=nx>next</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Here we use <code>stream.PassThrough</code> to establish a stream as an intemediary for passing the input bytes across to the output.</p><h1 id=break-data-into-chunks>Break data into chunks</h1><p>Well, the code above seems to work fine initially. However, in production, it hangs when attempting to
package and download large log files. I guess I should chunk the data during packaging due to memory limitations.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-TypeScript data-lang=TypeScript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>tarFile</span> <span class=o>=</span> <span class=p>(</span><span class=nx>files</span>: <span class=kt>string</span><span class=p>[])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=nx>Promise</span><span class=p>((</span><span class=nx>resolve</span><span class=p>,</span> <span class=nx>reject</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>passthrough</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>stream</span><span class=p>.</span><span class=nx>PassThrougth</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>tar</span><span class=p>.</span><span class=nx>c</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>gzip</span>: <span class=kt>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=nx>files</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;data&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>chunk</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>passthrough</span><span class=p>.</span><span class=nx>write</span><span class=p>(</span><span class=nx>chunk</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;end&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>passthrough</span><span class=p>.</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=nx>resolve</span><span class=p>(</span><span class=nx>passthrough</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=nx>reject</span><span class=p>(</span><span class=nx>err</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h1 id=node-tar-vs-tar-fs><code>node-tar</code> vs <code>tar-fs</code></h1><p>Another issue arises while tring to download a changing online log file, resulting the &ldquo;Error: did not encounter expected EOF&rdquo; error throw by the package <code>node-tar</code>. The only reference I have is this issue: <a href=https://github.com/isaacs/node-tar/issues/238>https://github.com/isaacs/node-tar/issues/238</a>. I realized this is a feature and upon inspecting the source code, I couldn&rsquo;t find a method to change this behavior without modifying the source code.</p><p>I had to switch to another package, <code>tar-fs</code>, for packaging, and it work seamlessly. While it does not offer a built-in gunzip feature, we have a native Node package called <code>zlib</code> that can be utilized. The final code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-TypeScript data-lang=TypeScript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>tarFiles</span> <span class=o>=</span> <span class=p>(</span><span class=nx>files</span>: <span class=kt>string</span><span class=p>[])</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>any</span><span class=p>&gt;</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=nx>Promise</span><span class=p>((</span><span class=nx>resolve</span><span class=p>,</span> <span class=nx>reject</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>passthrough</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>stream</span><span class=p>.</span><span class=nx>PassThrough</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>gz</span> <span class=o>=</span> <span class=nx>zlib</span><span class=p>.</span><span class=nx>createGzip</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>pack</span><span class=p>(</span><span class=nx>getLoggerFilePath</span><span class=p>(),</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>entries</span>: <span class=kt>files</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;data&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>chunk</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>passthrough</span><span class=p>.</span><span class=nx>write</span><span class=p>(</span><span class=nx>chunk</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;end&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>passthrough</span><span class=p>.</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=nx>reject</span><span class=p>(</span><span class=nx>err</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nx>passthrough</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;data&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>chunk</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>gz</span><span class=p>.</span><span class=nx>write</span><span class=p>(</span><span class=nx>chunk</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;end&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>gz</span><span class=p>.</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=nx>resolve</span><span class=p>(</span><span class=nx>gz</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=nx>reject</span><span class=p>(</span><span class=nx>err</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nx>gz</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=nx>reject</span><span class=p>(</span><span class=nx>err</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div></article><script src=https://giscus.app/client.js data-repo=xilesun/qqqydev data-repo-id=R_kgDOJHBOqg data-category=Comments data-category-id=DIC_kwDOJHBOqs4CXwE5 data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=en data-loading=lazy crossorigin=anonymous async></script></main><footer id=footer>Copyright © 2023 YANG QIA</footer></body></html>