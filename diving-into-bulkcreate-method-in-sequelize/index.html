<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="沉默入海"><link rel="shortcut icon" href=https://qqqy.dev/favicon.ico><link rel=stylesheet href=/css/style.min.css><link rel=canonical href=https://qqqy.dev/diving-into-bulkcreate-method-in-sequelize/><link href=https://cdn.bootcdn.net/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css rel=stylesheet><script src=https://cdn.bootcdn.net/ajax/libs/highlight.js/11.7.0/highlight.min.js></script>
<script>hljs.initHighlightingOnLoad()</script><title>Diving into bulkCreate method in Sequelize</title></head><body><header id=banner><h2><a href=https://qqqy.dev>沉海记</a></h2><nav><ul><li><a href=/categories/ title=categories>categories</a></li><li><a href=/about/ title=about>about</a></li><li><a href=/resume/ title=résumé>résumé</a></li></ul></nav></header><main id=content><article><header id=post-header><h1>Diving into bulkCreate method in Sequelize</h1><div><time>July 8, 2023</time></div></header><h1 id=background>Background</h1><p>During my recent development work on a data synchronization feature using <code>bulkCreate</code> method in <a href=https://sequelize.org/api/v6/class/src/model.js~model#static-method-bulkCreate>Sequelize</a>, I encountered an issue with incorrect returning IDs when using the <code>updateOnDuplicate: true</code> option. This led me to suspect that Sequelize generates the returning IDs through inference. To confirm my hypothesis, I decided to investigate the source code of Sequelize.</p><h1 id=how-sequelize-generate-returning-ids-in-bulkcreate>How Sequelize generate returning IDs in <code>bulkCreate</code></h1><p>Despite the extensive codebase of Sequelize, locating the <code>bulkCreate</code> method was straightforward. A global search within the codebase led me directly to the <code>src/model.js</code> file, where I found the relevant comment confirming my initial assumption.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>  * The success handler is passed an array of instances, but please notice that these may not completely represent the state of the rows in the DB. This is because MySQL
</span></span></span><span class=line><span class=cl><span class=cm>  * and SQLite do not make it easy to obtain back automatically generated IDs and other default values in a way that can be mapped to multiple records.
</span></span></span><span class=line><span class=cl><span class=cm>  * To obtain Instances for the newly created values, you will need to query for them again.
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span></code></pre></div><p>Next, I proceeded to investigate this method by following the code snippets below:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>// src/model.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>results</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>model</span><span class=p>.</span><span class=nx>queryInterface</span><span class=p>.</span><span class=nx>bulkInsert</span><span class=p>(</span><span class=nx>model</span><span class=p>.</span><span class=nx>getTableName</span><span class=p>(</span><span class=nx>options</span><span class=p>),</span> <span class=nx>records</span><span class=p>,</span> <span class=nx>options</span><span class=p>,</span> <span class=nx>fieldMappedAttributes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>static</span> <span class=nx>get</span> <span class=nx>queryInterface</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>sequelize</span><span class=p>.</span><span class=nx>getQueryInterface</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>// src/sequelize.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>this</span><span class=p>.</span><span class=nx>queryInterface</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>dialect</span><span class=p>.</span><span class=nx>queryInterface</span><span class=p>;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>// src/dialects/sqlite/index.js
</span></span></span><span class=line><span class=cl><span class=c1>// Just take SQLite as an example.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>this</span><span class=p>.</span><span class=nx>queryInterface</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>SQLiteQueryInterface</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>sequelize</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=p>.</span><span class=nx>queryGenerator</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// src/dialects/sqlite/query-interface.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>class</span> <span class=nx>SQLiteQueryInterface</span> <span class=kr>extends</span> <span class=nx>QueryInterface</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>// src/dialects/abstract/query-generator.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>async</span> <span class=nx>bulkInsert</span><span class=p>(</span><span class=nx>tableName</span><span class=p>,</span> <span class=nx>records</span><span class=p>,</span> <span class=nx>options</span><span class=p>,</span> <span class=nx>attributes</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>options</span> <span class=o>=</span> <span class=p>{</span> <span class=p>...</span><span class=nx>options</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=nx>options</span><span class=p>.</span><span class=nx>type</span> <span class=o>=</span> <span class=nx>QueryTypes</span><span class=p>.</span><span class=nx>INSERT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>results</span> <span class=o>=</span> <span class=kr>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>sequelize</span><span class=p>.</span><span class=nx>query</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>queryGenerator</span><span class=p>.</span><span class=nx>bulkInsertQuery</span><span class=p>(</span><span class=nx>tableName</span><span class=p>,</span> <span class=nx>records</span><span class=p>,</span> <span class=nx>options</span><span class=p>,</span> <span class=nx>attributes</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nx>options</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>results</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>// src/sequelize.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>async</span> <span class=nx>query</span><span class=p>(</span><span class=nx>sql</span><span class=p>,</span> <span class=nx>options</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>query</span> <span class=o>=</span> <span class=k>new</span> <span class=k>this</span><span class=p>.</span><span class=nx>dialect</span><span class=p>.</span><span class=nx>Query</span><span class=p>(</span><span class=nx>connection</span><span class=p>,</span> <span class=k>this</span><span class=p>,</span> <span class=nx>options</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=kr>await</span> <span class=nx>query</span><span class=p>.</span><span class=nx>run</span><span class=p>(</span><span class=nx>sql</span><span class=p>,</span> <span class=nx>bindParameters</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>// src/dialects/sqlite/query.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>async</span> <span class=nx>run</span><span class=p>(</span><span class=nx>sql</span><span class=p>,</span> <span class=nx>parameters</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>resolve</span><span class=p>(</span><span class=nx>query</span><span class=p>.</span><span class=nx>_handleQueryResponse</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=nx>columnTypes</span><span class=p>,</span> <span class=nx>executionError</span><span class=p>,</span> <span class=nx>results</span><span class=p>,</span> <span class=nx>errForStack</span><span class=p>.</span><span class=nx>stack</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><p>And finally I got what I was aiming for:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>// src/dialects/sqlite/query.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>_handleQueryResponse</span><span class=p>(</span><span class=nx>metaData</span><span class=p>,</span> <span class=nx>columnTypes</span><span class=p>,</span> <span class=nx>err</span><span class=p>,</span> <span class=nx>results</span><span class=p>,</span> <span class=nx>errStack</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// add the inserted row id to the instance
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>isInsertQuery</span><span class=p>(</span><span class=nx>results</span><span class=p>,</span> <span class=nx>metaData</span><span class=p>)</span> <span class=o>||</span> <span class=k>this</span><span class=p>.</span><span class=nx>isUpsertQuery</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>handleInsertQuery</span><span class=p>(</span><span class=nx>results</span><span class=p>,</span> <span class=nx>metaData</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>instance</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// handle bulkCreate AI primary key
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>metaData</span><span class=p>.</span><span class=nx>constructor</span><span class=p>.</span><span class=nx>name</span> <span class=o>===</span> <span class=s1>&#39;Statement&#39;</span>
</span></span><span class=line><span class=cl>        <span class=o>&amp;&amp;</span> <span class=k>this</span><span class=p>.</span><span class=nx>model</span>
</span></span><span class=line><span class=cl>        <span class=o>&amp;&amp;</span> <span class=k>this</span><span class=p>.</span><span class=nx>model</span><span class=p>.</span><span class=nx>autoIncrementAttribute</span>
</span></span><span class=line><span class=cl>        <span class=o>&amp;&amp;</span> <span class=k>this</span><span class=p>.</span><span class=nx>model</span><span class=p>.</span><span class=nx>autoIncrementAttribute</span> <span class=o>===</span> <span class=k>this</span><span class=p>.</span><span class=nx>model</span><span class=p>.</span><span class=nx>primaryKeyAttribute</span>
</span></span><span class=line><span class=cl>        <span class=o>&amp;&amp;</span> <span class=k>this</span><span class=p>.</span><span class=nx>model</span><span class=p>.</span><span class=nx>rawAttributes</span><span class=p>[</span><span class=k>this</span><span class=p>.</span><span class=nx>model</span><span class=p>.</span><span class=nx>primaryKeyAttribute</span><span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>startId</span> <span class=o>=</span> <span class=nx>metaData</span><span class=p>[</span><span class=k>this</span><span class=p>.</span><span class=nx>getInsertIdField</span><span class=p>()]</span> <span class=o>-</span> <span class=nx>metaData</span><span class=p>.</span><span class=nx>changes</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>result</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=nx>startId</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>startId</span> <span class=o>+</span> <span class=nx>metaData</span><span class=p>.</span><span class=nx>changes</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>result</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span> <span class=p>[</span><span class=k>this</span><span class=p>.</span><span class=nx>model</span><span class=p>.</span><span class=nx>rawAttributes</span><span class=p>[</span><span class=k>this</span><span class=p>.</span><span class=nx>model</span><span class=p>.</span><span class=nx>primaryKeyAttribute</span><span class=p>].</span><span class=nx>field</span><span class=p>]</span><span class=o>:</span> <span class=nx>i</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>result</span> <span class=o>=</span> <span class=nx>metaData</span><span class=p>[</span><span class=k>this</span><span class=p>.</span><span class=nx>getInsertIdField</span><span class=p>()];</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><p>Upon the <code>_handleQueryResponse</code> method, it became apparent that Sequelize utilizes the last inserted ID and infers the remaining IDs when using <code>bulkCreate</code>. Consequently, when using <code>updateOnDuplicate: true</code> option, there is a possibility of receiving incorrect IDs in the return.</p><blockquote><p><strong>A handy tip for obtaining accurate IDs</strong><br>Enhance the data table by introducing a <code>batch</code> field, assigning a batch number to each set of data being inserted. Subsequently, you can query the inserted IDs by using the corresponding batch number.</p></blockquote><h1 id=risk-of-using-updateonduplicate-true>Risk of using <code>updateOnDuplicate: true</code></h1><p>While utilizing the <code>updateOnDuplicate: true</code> option, I observed that even though duplicate rows are skipped, the <code>autoIncrement</code> key continues to increment. From the <a href=https://dev.mysql.com/doc/refman/8.0/en/insert-on-duplicate.html>documentation of MySQL</a>, it said:</p><blockquote><p>The effects are not quite identical: For an InnoDB table where a is an auto-increment column, the INSERT statement increases the auto-increment value but the UPDATE does not.</p></blockquote><p>The database follows a process of attempting to insert, incrementing the ID, and then the duplicate is detected. However, once the ID is auto-incremented, it cannot be rolled back.</p><p>This situation presents a potential risk when utilizing a master-slave database architecture. As the ID is auto-incremented but duplicate is detected, the operation do not leave bin logs, there is a chance for key conficts to arise when the master goes down and the slave is promoted as the new master.</p></article><script src=https://giscus.app/client.js data-repo=xilesun/qqqydev data-repo-id=R_kgDOJHBOqg data-category=Comments data-category-id=DIC_kwDOJHBOqs4CXwE5 data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=en data-loading=lazy crossorigin=anonymous async></script></main><footer id=footer>Copyright © 2023 YANG QIA</footer></body></html>